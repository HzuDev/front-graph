---
import OnboardingStep from "../../components/onboarding/OnboardingStep.astro";
import { MapPin, Globe, ArrowRight, Loader2, Search } from "lucide-react";
---

<OnboardingStep step={2} totalSteps={4} title="Tu Lugar" eyebrow="Tu Lugar">
    <div slot="left-content">
        <h1
            class="text-6xl md:text-8xl font-black text-hunter leading-[0.85] tracking-tighter mb-6"
        >
            Tu <br />
            <span
                class="text-transparent bg-clip-text bg-linear-to-r from-hunter to-hunter/20"
            >
                Municipio.
            </span>
        </h1>
        <p
            class="text-hunter/60 text-lg md:text-xl max-w-md font-medium leading-relaxed"
        >
            Bolivia tiene cientos de municipios. Encuentra a los candidatos de
            tu zona para votar informado.
        </p>
    </div>

    <div slot="left-features">
        <div class="flex items-center gap-3 text-hunter/80">
            <div class="p-2 bg-white/5 rounded-lg border border-white/5">
                <MapPin size={20} />
            </div>
            <span class="text-sm font-semibold">Geolocalizaci√≥n</span>
        </div>
        <div class="flex items-center gap-3 text-hunter/80">
            <div class="p-2 bg-white/5 rounded-lg border border-white/5">
                <Globe size={20} />
            </div>
            <span class="text-sm font-semibold">Filtro Autom√°tico</span>
        </div>
    </div>

    <div slot="background-icon" class="animate-float">
        <MapPin
            size={460}
            strokeWidth={0.5}
            color="currentColor"
            className="text-hunter opacity-5"
        />
    </div>

    <div slot="right-content">
        <div id="location-content" class="relative">
            <h3
                class="text-4xl font-extrabold text-primary-green tracking-tight leading-tight"
            >
                ¬øD√≥nde votas?
            </h3>
            <p class="text-primary-green/70 font-medium mt-4">
                Si compartes tu ubicaci√≥n, te mostraremos autom√°ticamente a los
                candidatos de tu circunscripci√≥n.
            </p>

            <div
                id="status-container"
                class="mt-4 empty:hidden transition-all duration-300"
            >
            </div>
        </div>
    </div>

    <div slot="actions" class="space-y-4">
        <button
            id="btn-location"
            class="w-full group bg-primary-green text-hunter p-5 rounded-2xl font-bold text-lg flex items-center justify-between hover:shadow-2xl hover:shadow-primary-green/30 transition-all hover:scale-[1.02] active:scale-[0.98] disabled:opacity-70 disabled:cursor-wait"
        >
            <span class="flex items-center gap-2">
                <MapPin className="w-5 h-5" />
                <span id="btn-location-text">Usar mi ubicaci√≥n</span>
            </span>
            <ArrowRight
                className="group-hover:translate-x-1 transition-transform"
            />
        </button>

        <div class="w-full space-y-3 relative">
            <div class="relative group">
                <input
                    id="manual-search-input"
                    type="text"
                    autocomplete="off"
                    placeholder="Buscar municipio o provincia..."
                    class="w-full bg-white border-2 border-primary-green/10 text-primary-green pl-12 pr-4 py-4 rounded-2xl font-semibold text-base placeholder:text-primary-green/40 focus:outline-none focus:border-primary-green/30 focus:shadow-lg focus:shadow-primary-green/5 transition-all"
                />

                <div
                    id="search-results"
                    class="hidden absolute top-[calc(100%+8px)] left-0 right-0 bg-white border border-primary-green/10 rounded-2xl shadow-xl max-h-64 overflow-y-auto z-50 scrollbar-thin scrollbar-thumb-primary-green/10 scrollbar-track-transparent"
                >
                </div>
            </div>

            <button
                id="continue-btn"
                disabled
                class="w-full bg-primary-green/5 p-5 rounded-2xl font-bold text-lg hover:bg-primary-green/10 text-primary-green transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-between group"
            >
                <span>Continuar</span>
                <ArrowRight
                    className="w-5 h-5 group-hover:translate-x-1 transition-transform"
                />
            </button>
        </div>
    </div>
</OnboardingStep>

<script>
    import {
        findMunicipalityByCoordinates,
        fetchPolygons,
    } from "../../lib/queries";

    // --- Tipos ---
    type MunicipalityIndex = { name: string; id: string; searchStr: string };
    type LocationData = {
        lat: number;
        lon: number;
        municipalityId: string;
        municipalityName: string;
        departmentName: string;
        detectionMethod: "gps" | "ip" | "manual";
    };

    // --- State Global ---
    let searchIndex: MunicipalityIndex[] = [];
    let polygonsData: any[] = [];
    let isDataLoaded = false;
    let selectedMunicipality: {
        id: string;
        name: string;
        department?: string;
    } | null = null;
    let abortController: AbortController | null = null;

    // --- Referencias DOM (cacheadas) ---
    const ui = {
        btnLocation: document.getElementById(
            "btn-location",
        ) as HTMLButtonElement,
        btnText: document.getElementById(
            "btn-location-text",
        ) as HTMLSpanElement,
        statusContainer: document.getElementById(
            "status-container",
        ) as HTMLDivElement,
        input: document.getElementById(
            "manual-search-input",
        ) as HTMLInputElement,
        results: document.getElementById("search-results") as HTMLDivElement,
        continueBtn: document.getElementById(
            "continue-btn",
        ) as HTMLButtonElement,
    };

    // --- Utilidades ---

    // Normaliza texto para b√∫squeda insensible a acentos (e.g., "Bol√≠var" == "bolivar")
    const normalize = (str: string) =>
        str
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .toLowerCase();

    // Renderiza Spinner SVG
    const getSpinner = () => `
        <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>`;

    const showStatus = (
        type: "error" | "success",
        title: string,
        message?: string,
    ) => {
        const colors =
            type === "error"
                ? "bg-red-50 text-red-800 border-red-200"
                : "bg-green-50 text-green-800 border-green-200";
        const icon = type === "error" ? "‚ö†Ô∏è" : "‚úÖ";

        ui.statusContainer.innerHTML = `
            <div class="p-4 rounded-lg border ${colors} flex items-start gap-3 animate-in fade-in slide-in-from-top-2 duration-300">
                <span class="text-lg select-none">${icon}</span>
                <div>
                    <p class="font-bold text-sm">${title}</p>
                    ${message ? `<p class="text-xs mt-1 opacity-90">${message}</p>` : ""}
                </div>
            </div>
        `;
        ui.statusContainer.classList.remove("hidden");
    };

    const clearStatus = () => {
        ui.statusContainer.innerHTML = "";
        ui.statusContainer.classList.add("hidden");
    };

    // --- Inicializaci√≥n de Datos ---
    const initData = async () => {
        try {
            // Carga diferida inteligente
            const polygons = await fetchPolygons();
            polygonsData = polygons;
            // Crear √≠ndice ligero para b√∫squeda r√°pida
            searchIndex = polygons.map((p: any) => ({
                name: p.entityLabel,
                id: p.entityId,
                searchStr: normalize(p.entityLabel), // Pre-computar string normalizado
            }));
            isDataLoaded = true;
            console.log(
                "üìç Datos de municipios precargados:",
                searchIndex.length,
            );
        } catch (err) {
            console.error("Error cargando pol√≠gonos:", err);
        }
    };

    // Iniciar carga inmediatamente pero no bloquear
    if (typeof window !== "undefined") initData();

    // --- L√≥gica de Geolocalizaci√≥n ---

    const getPosition = (
        options?: PositionOptions,
    ): Promise<GeolocationPosition> => {
        return new Promise((resolve, reject) => {
            if (!navigator.geolocation) reject(new Error("No soportado"));
            navigator.geolocation.getCurrentPosition(resolve, reject, options);
        });
    };

    const handleLocationClick = async () => {
        clearStatus();
        ui.btnLocation.disabled = true;
        const originalText = ui.btnText.textContent;

        // Estado de carga
        ui.btnLocation.querySelector("svg")?.classList.add("hidden"); // ocultar icono map
        const spinnerContainer = document.createElement("div");
        spinnerContainer.innerHTML = getSpinner();
        ui.btnLocation.firstElementChild?.prepend(
            spinnerContainer.firstElementChild!,
        );
        ui.btnText.textContent = "Detectando ubicaci√≥n...";

        try {
            // 1. Intentar GPS de alta precisi√≥n
            let position: GeolocationPosition;
            try {
                position = await getPosition({
                    timeout: 8000,
                    enableHighAccuracy: true,
                });
            } catch (gpsError) {
                console.warn("Fallo GPS, intentando IP...", gpsError);
                // 2. Fallback a IP
                ui.btnText.textContent = "Usando ubicaci√≥n aproximada...";
                const ipRes = await fetch("https://ipapi.co/json/");
                if (!ipRes.ok) throw new Error("IP API fall√≥");
                const ipData = await ipRes.json();

                // Simular estructura GeolocationPosition
                position = {
                    coords: {
                        latitude: ipData.latitude,
                        longitude: ipData.longitude,
                        accuracy: 1000,
                        altitude: null,
                        altitudeAccuracy: null,
                        heading: null,
                        speed: null,
                    },
                    timestamp: Date.now(),
                } as GeolocationPosition;
            }

            // 3. Procesar coordenadas
            const { latitude, longitude } = position.coords;
            ui.btnText.textContent = "Buscando municipio...";

            // Asegurar que tenemos los datos para comparar
            if (!isDataLoaded) await fetchPolygons();

            const municipality = await findMunicipalityByCoordinates(
                latitude,
                longitude,
            );

            if (municipality) {
                const locationData: LocationData = {
                    lat: latitude,
                    lon: longitude,
                    municipalityId: municipality.$id,
                    municipalityName:
                        municipality.label || "Municipio detectado",
                    departmentName: "", // TODO: Extraer del objeto si existe
                    detectionMethod: "gps",
                };

                // Guardar y redirigir
                localStorage.setItem(
                    "user_location",
                    JSON.stringify({ lat: latitude, lon: longitude }),
                );
                localStorage.setItem(
                    "detected_municipality",
                    JSON.stringify(locationData),
                );

                // √âxito UI
                ui.btnLocation.className =
                    "w-full bg-green-600 text-white p-5 rounded-2xl font-bold text-lg flex items-center justify-center gap-2 shadow-lg scale-[1.02]";
                ui.btnLocation.innerHTML = `<span>‚úÖ ¬°Encontrado: ${municipality.label}!</span>`;
                showStatus(
                    "success",
                    "Ubicaci√≥n detectada",
                    `Municipio: ${municipality.label}`,
                );

                setTimeout(
                    () =>
                        (window.location.href =
                            import.meta.env.BASE_URL + "/onboarding/3"),
                    1000,
                );
            } else {
                throw new Error("Fuera de rango");
            }
        } catch (error: any) {
            console.error(error);
            // Restaurar bot√≥n
            ui.btnLocation.disabled = false;
            ui.btnLocation.innerHTML = `
                <span class="flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>
                    <span>Intentar de nuevo</span>
                </span>
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
            `;

            let msg = "No pudimos detectar tu ubicaci√≥n.";
            if (error.code === 1)
                msg = "Necesitamos permiso para usar tu ubicaci√≥n.";
            showStatus(
                "error",
                "Error de ubicaci√≥n",
                `${msg} Por favor busca manualmente abajo.`,
            );
        }
    };

    // --- L√≥gica de B√∫squeda Manual ---

    const renderResults = (results: any[], source: "local" | "osm") => {
        ui.results.innerHTML = "";

        if (results.length === 0) {
            ui.results.innerHTML = `<div class="p-4 text-sm text-primary-green/50 text-center">No encontramos resultados.</div>`;
            return;
        }

        const fragment = document.createDocumentFragment();

        results.forEach((item) => {
            const btn = document.createElement("button");
            btn.className =
                "w-full text-left p-3 hover:bg-primary-green/5 transition-colors border-b border-primary-green/5 last:border-0 flex justify-between items-center group";

            // Determinar datos seg√∫n fuente
            const name =
                source === "local"
                    ? item.name
                    : item.display_name.split(",")[0];
            const meta =
                source === "local"
                    ? "Bolivia"
                    : item.address?.state || "Bolivia";

            btn.innerHTML = `
                <div>
                    <div class="font-bold text-primary-green group-hover:text-primary-green/80">${name}</div>
                    <div class="text-xs text-primary-green/50 uppercase tracking-wider font-medium">${meta}</div>
                </div>
                ${source === "osm" ? '<span class="text-[10px] bg-primary-green/10 px-2 py-1 rounded text-primary-green/60">OSM</span>' : ""}
            `;

            btn.onclick = () => selectManualLocation(item, source);
            fragment.appendChild(btn);
        });

        ui.results.appendChild(fragment);
        ui.results.classList.remove("hidden");
    };

    const searchNominatim = async (query: string) => {
        if (abortController) abortController.abort();
        abortController = new AbortController();

        try {
            const res = await fetch(
                `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&countrycodes=bo&format=json&addressdetails=1&limit=5`,
                { signal: abortController.signal },
            );
            return await res.json();
        } catch (err: any) {
            if (err.name !== "AbortError") console.error(err);
            return [];
        }
    };

    const handleSearchInput = async (e: Event) => {
        const value = (e.target as HTMLInputElement).value.trim();
        const cleanValue = normalize(value);

        if (value.length < 2) {
            ui.results.classList.add("hidden");
            return;
        }

        // 1. B√∫squeda Local (Instant√°nea)
        // Filtramos el √≠ndice ligero, no los objetos pesados
        const localMatches = searchIndex
            .filter((item) => item.searchStr.includes(cleanValue))
            .slice(0, 5);

        if (localMatches.length > 0) {
            renderResults(localMatches, "local");
            return; // Si hay locales, no molestamos a Nominatim
        }

        // 2. Fallback a Nominatim (Si no hay local)
        ui.results.innerHTML = `<div class="p-4 flex items-center justify-center gap-2 text-sm text-primary-green/50">${getSpinner()} Buscando en l√≠nea...</div>`;
        ui.results.classList.remove("hidden");

        const osmResults = await searchNominatim(value);
        renderResults(osmResults, "osm");
    };

    const selectManualLocation = (item: any, source: "local" | "osm") => {
        const name =
            source === "local" ? item.name : item.display_name.split(",")[0];

        selectedMunicipality = {
            id: source === "local" ? item.id : `osm-${item.place_id}`,
            name: name,
            department: source === "osm" ? item.address?.state : undefined,
        };

        // Guardar coordenadas si vienen de OSM
        if (source === "osm" && item.lat && item.lon) {
            localStorage.setItem(
                "user_location",
                JSON.stringify({
                    lat: parseFloat(item.lat),
                    lon: parseFloat(item.lon),
                }),
            );
        }

        ui.input.value = name;
        ui.results.classList.add("hidden");
        ui.continueBtn.disabled = false;
        ui.continueBtn.classList.remove("opacity-50", "cursor-not-allowed");
    };

    // --- Listeners ---
    ui.btnLocation.addEventListener("click", handleLocationClick);

    // Debounce para el input
    let timeoutId: number;
    ui.input.addEventListener("input", (e) => {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => handleSearchInput(e), 300);
    });

    // Cerrar dropdown al hacer click fuera
    document.addEventListener("click", (e) => {
        if (
            !ui.input.contains(e.target as Node) &&
            !ui.results.contains(e.target as Node)
        ) {
            ui.results.classList.add("hidden");
        }
    });

    ui.continueBtn.addEventListener("click", () => {
        if (!selectedMunicipality) return;

        const locationData: LocationData = {
            lat: 0,
            lon: 0, // Placeholder si es manual puro sin coords
            municipalityId: selectedMunicipality.id,
            municipalityName: selectedMunicipality.name,
            departmentName: selectedMunicipality.department || "",
            detectionMethod: "manual",
        };

        localStorage.setItem(
            "detected_municipality",
            JSON.stringify(locationData),
        );
        window.location.href = import.meta.env.BASE_URL + "/onboarding/3";
    });
</script>
