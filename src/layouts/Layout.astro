---
import { ClientRouter } from 'astro:transitions';
import Footer from '../components/common/Footer.astro';
import Navbar from '../components/common/Navbar.astro';
import '../styles/global.css';

interface Props {
  title?: string;
}

const { title = 'Monitor Elecciones' } = Astro.props;
const { pathname } = Astro.url;
const isOnboarding = pathname.includes('/onboarding');
---

<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self';
		               script-src 'self' 'unsafe-inline' 'unsafe-eval' https://nominatim.openstreetmap.org;
		               style-src 'self' 'unsafe-inline';
		               img-src 'self' data: https:;
		               connect-src 'self' https://cloud.appwrite.io https://appwrite.sociest.org https://nominatim.openstreetmap.org https://maps.googleapis.com https://ipapi.co;
		               font-src 'self' data:;
		               frame-ancestors 'self';
		               base-uri 'self';
		               form-action 'self'"
    />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <meta http-equiv="X-Content-Type-Options" content="nosniff" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="icon" href="/favicon.ico" />
    <meta name="generator" content={Astro.generator} />
    <ClientRouter />
    <title>{title}</title>

    {
      import.meta.env.PUBLIC_GA_ID && (
        <>
          <script
            is:inline
            async
            src={`https://www.googletagmanager.com/gtag/js?id=${import.meta.env.PUBLIC_GA_ID}`}
          />
          <script
            is:inline
            define:vars={{ gaId: import.meta.env.PUBLIC_GA_ID }}
          >
            window.dataLayer = window.dataLayer || [];
            function gtag() {
              window.dataLayer.push(arguments);
            }
            gtag('js', new Date());

            gtag('config', gaId);
          </script>
        </>
      )
    }

    <script
      is:inline
      define:vars={{
        baseRoute: (import.meta.env.PUBLIC_BASE_ROUTE ?? '/').replace(
          /\/+$/,
          ''
        ),
      }}
    >
      (function () {
        const onboardingCompleted = localStorage.getItem(
          'onboarding_completed'
        );

        const cleanBase = baseRoute === '' ? '' : baseRoute;

        const isOnboardingPage =
          window.location.pathname.includes('/onboarding');

        if (!onboardingCompleted && !isOnboardingPage) {
          const redirectPath = cleanBase + '/onboarding/1';

          window.location.href = redirectPath;
        }
      })();
    </script>
  </head>
  <body class="flex flex-col min-h-screen">
    {!isOnboarding && <Navbar />}
    <main id="main-content" class="grow flex flex-col">
      <slot />
    </main>
    {!isOnboarding && <Footer />}
  </body>
</html>

<script>
  function adjustPadding() {
    const header = document.querySelector('header');
    const main = document.getElementById('main-content');
    if (header && main) {
      main.style.paddingTop = `${header.offsetHeight}px`;
    }
  }

  // Adjust on load and resize
  window.addEventListener('load', adjustPadding);
  window.addEventListener('resize', adjustPadding);
  document.addEventListener('astro:page-load', adjustPadding);
</script>

<style>
  html,
  body {
    margin: 0;
    width: 100%;
  }
</style>
